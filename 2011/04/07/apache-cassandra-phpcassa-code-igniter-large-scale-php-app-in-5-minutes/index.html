<!DOCTYPE html>
<html>
        <head>
    <title>Apache Cassandra + PHPcassa + Code Igniter = large scale PHP app in 5 minutes</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="description" content="I&#39;m working on a new project, migrating an existing site using custom code with a very monolithic design on top of MySQL.">
    <meta name="keywords" content="" />
    <script src="/js/jquery.min.js"></script>
    <script src="/js/init.js"></script>

    <link rel="stylesheet" href="/css/main.css">

    <link rel="canonical" href="//2011/04/07/apache-cassandra-phpcassa-code-igniter-large-scale-php-app-in-5-minutes">
    <link rel="alternate" type="application/atom+xml" title="zcourts AKA Courtney Robinson" href="/feed.xml" />
</head>
    <body>
        <!-- Header -->
<div id="header" class="skel-layers-fixed">

    <div class="top">

        <!-- Logo -->
        <div id="logo">
            <span class="image avatar48"><img src="/images/avatar.jpg" alt=""/></span>

            <h1 id="title">zcourts</h1>
            <p>Courtney Robinson</p>
            <p>Software Engineer</p>
            <p>PhD Student</p>
        </div>

        <!-- Nav -->
        <nav id="nav">
            <!--

                Prologue's nav expects links in one of two formats:

                1. Hash link (scrolls to a different section within the page)

                   <li><a href="#foobar" id="foobar-link" class="icon fa-whatever-icon-you-want skel-layers-ignoreHref"><span class="label">Foobar</span></a></li>

                2. Standard link (sends the user to another page/site)

                   <li><a href="http://foobar.tld" id="foobar-link" class="icon fa-whatever-icon-you-want"><span class="label">Foobar</span></a></li>

            -->
            <ul>
                <li><a href="/#top" id="top-link" class="skel-layers-ignoreHref"><span class="icon fa-home">Home</span></a></li>
                <li><a href="/#portfolio" id="portfolio-link" class="skel-layers-ignoreHref"><span class="icon fa-th">Projects</span></a></li>
                <li><a href="/posts" id="blog-link" class="skel-layers-ignoreHref"><span class=" glyphicon glyphicon-comment">Blog posts</span></a></li>
                <li><a href="/categories.html" id="cat-link" class="skel-layers-ignoreHref"><span class=" glyphicon glyphicon-tags">Categories</span></a></li>
                <li><a href="/about-courtney-robinson" id="about-link" class="skel-layers-ignoreHref"><span class="icon fa-user">About Me</span></a></li>
                <li><a href="/#contact" id="contact-link" class="skel-layers-ignoreHref"><span class="icon fa-envelope">Contact</span></a></li>
            </ul>
        </nav>

    </div>

    <div class="bottom">

        <!-- Social Icons -->
        <ul class="icons">
            <li><a href="https://twitter.com/zcourts" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
            <li><a href="https://www.facebook.com/zcourts" class="icon fa-facebook"><span class="label">Facebook</span></a></li>
            <li><a href="https://github.com/zcourts" class="icon fa-github"><span class="label">Github</span></a></li>
            <li><a href="mailto:site@crlog.info" class="icon fa-envelope"><span class="label">Email</span></a></li>
        </ul>

    </div>

</div>
        <!-- Main -->
        <div id="main">
            <div class="post">

    <header class="post-header">
        <h1 class="post-title">Apache Cassandra + PHPcassa + Code Igniter = large scale PHP app in 5 minutes</h1>

        <p class="post-meta">Apr 7, 2011 • zcourts
            
        <div class="share-post-header">
            <span class='st_reddit_large' displayText='Reddit'></span>
            <span class='st_facebook_large' displayText='Facebook'></span>
            <span class='st_twitter_large' displayText='Tweet'></span>
            <span class='st_linkedin_large' displayText='LinkedIn'></span>
            <span class='st_pinterest_large' displayText='Pinterest'></span>
            <span class='st_tumblr_large' displayText='Tumblr'></span>
            <span class='st_wordpress_large' displayText='WordPress'></span>
            <span class='st_googleplus_large' displayText='Google +'></span>
            <span class='st_yammer_large' displayText='Yammer'></span>
            <span class='st_blogger_large' displayText='Blogger'></span>
            <span class='st_email_large' displayText='Email'></span>
        </div>
        </p>
    </header>

    <article class="post-content">
        <p>I&#39;m working on a new project, migrating an existing site using custom code with a very monolithic design on top of <a href="http://www.mysql.com/">MySQL</a>.</p>

<p>Design goals : Implement all the same functionality using a manageable framework with a small footprint on a distributed NoSQL database.
Small footprint? I&#39;m thinking <a href="http://codeigniter.com/">Code Igniter</a> (CI)... Distributed NoSQL (my favorite part)? I&#39;m thinking <a href="http://cassandra.apache.org">Apache Cassandra</a>!!!
First problem...issue, whatever you want to call it. CI is built with SQL DB tied in fairly tightly. How do I separate the two without hacking the CI core and allow me to have the flexibility of upgrading CI in the future? And at the same time being able to integrate Cassandra tightly enough to not make it stand out like <del>a penguin in Africa </del> sore thumb?</p>

<p>Enough with the questions, I&#39;m very new to CI so this took me about an hour to make it happen. The idea is, CI provides a $this-&gt;db object when &quot;database&quot; is one of the auto loaded options. I want to still have this db instance available but providing  methods to access Cassandra. I also want this to be auto loaded and available in all controllers... So how?&lt;!-- more --&gt;</p>

<p>PHPCassa is probably one of the best PHP client libraries available for Cassandra so the choice on library was about 20 seconds. Since I wasn&#39;t going to use raw thrift calls, this choice was even easier.</p>

<p>Get started then:
Create a file, in your application/config folder, name it cassandra.php i.e. application/config/cassandra.php
In that file add the following:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$servers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'host'</span> <span class="o">=&gt;</span> <span class="s1">'192.168.2.6'</span><span class="p">,</span> <span class="s1">'port'</span> <span class="o">=&gt;</span> <span class="mi">9160</span><span class="p">);</span>
<span class="nv">$servers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'host'</span> <span class="o">=&gt;</span> <span class="s1">'192.168.2.7'</span><span class="p">,</span> <span class="s1">'port'</span> <span class="o">=&gt;</span> <span class="mi">9160</span><span class="p">);</span>
<span class="nv">$servers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'host'</span> <span class="o">=&gt;</span> <span class="s1">'192.168.2.8'</span><span class="p">,</span> <span class="s1">'port'</span> <span class="o">=&gt;</span> <span class="mi">9160</span><span class="p">);</span>
<span class="nv">$config</span><span class="p">[</span><span class="s1">'cassandra_servers'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$servers</span><span class="p">;</span>
<span class="nv">$config</span><span class="p">[</span><span class="s1">'keyspace'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Keyspace1"</span><span class="p">;</span>
<span class="nv">$config</span><span class="p">[</span><span class="s1">'default_cf'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Standard1"</span><span class="p">;</span>
</code></pre></div>
<p>The servers array should be obvious, its a list of servers you want to have available for your connection
pooling stuff. It&#39;ll later be accessible using:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php">$this-&gt;CI-&gt;config-&gt;item('cassandra_servers')
</code></pre></div>
<p>The next config option is the Keyspace your application will use, this allows you to specify only a single Keyspace
since, ideally an application would only use one of these. This is later accessible through:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php">$this-&gt;CI-&gt;config-&gt;item('keyspace')
</code></pre></div>
<p>The final option is a default column family. This column family is the one that will be available when CI initialises
the database object, db.Later available using:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php">$this-&gt;CI-&gt;config-&gt;item('default_cf')
</code></pre></div>
<p>That&#39;s it for the configuration file... Next up, our Cassandra library or libraries should I say...
At this point its important to say that if you have database being auto loaded then the following may
not be what you want to do.
In application/libraries create a file called db.php i.e. application/libraries/db.php</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">require_once</span><span class="p">(</span><span class="s1">'phpcassa/connection.php'</span><span class="p">);</span>
<span class="k">require_once</span><span class="p">(</span><span class="s1">'phpcassa/columnfamily.php'</span><span class="p">);</span>

<span class="sd">/**
 * @author Courtney
 */</span>
<span class="k">class</span> <span class="nc">Db</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nv">$CI</span><span class="p">;</span>
<span class="c1">//    public $db;
</span>    <span class="k">private</span> <span class="nv">$conn</span><span class="p">;</span>
    <span class="sd">/**
     * @var ColumnFamily
     */</span>
    <span class="k">private</span> <span class="nv">$cf</span><span class="p">;</span>

    <span class="sd">/**
     * Init connection for the database using the settings in the cassandra.php
     * config file...
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">CI</span> <span class="o">=</span> <span class="o">&amp;</span> <span class="nx">get_instance</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">conn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Connection</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">CI</span><span class="o">-&gt;</span><span class="na">config</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="s1">'keyspace'</span><span class="p">),</span>
                            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">CI</span><span class="o">-&gt;</span><span class="na">config</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="s1">'cassandra_servers'</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">show_error</span><span class="p">(</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cf</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">CI</span><span class="o">-&gt;</span><span class="na">config</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="s1">'default_cf'</span><span class="p">);</span>
<span class="c1">//        $this-&gt;db = $this;
</span>    <span class="p">}</span>

    <span class="sd">/**
     * Creates a new instance of the given CF which will be returned
     * for interaction by &lt;code&gt;cf()&lt;/code&gt;
     * @param string $cf The column family to interact with
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setCF</span><span class="p">(</span><span class="nv">$cf</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ColumnFamily</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">conn</span><span class="p">,</span> <span class="nv">$cf</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Returns the instance of the last column family created by
     * calling &lt;code&gt;setCF()&lt;/code&gt;... If setCF hasn't been called
     * then the default_cf set in cassandra.php config file is returned,
     * once setCF is called then the last one to be set is always returned.
     * @return ColumnFamily
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">cf</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cf</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<p>This approach is the most simplistic I could think of for this blog post, ideally you&#39;d want to cache
the Column family objects you create so that a new instance isn&#39;t created every time you use a different CF.
There will is a basic caching version implemented on the github page hosting this project&#39;s files... available here
<a href="https://github.com/zcourts/cassandraci">https://github.com/zcourts/cassandraci</a>
Its important to name the file db.php if you want to be able to access the database instance using $this-&gt;db as you
would if it was the native CI MySQL object. That purely because CI automatically creates an instance of your library
using the name of the file or class (Not sure but file =db.php class =Db.php so...)
The next important step, download phpcassa... Its available here <a href="https://github.com/thobbs/phpcassa">https://github.com/thobbs/phpcassa</a>
Extract its contents and put its files into application/libraries/phpcassa, the structure needs to be in the form
to allow db.php to include &quot;phpcassa/ColumnFamily.php&quot;; etc... You only need the .php files from php cassa and
everything in the Thrift folder, docs and test folder aren&#39;t used so they can be left out.</p>

<p>Next you need to change your autoload.php file
the settings need to look like:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php">$autoload['libraries'] = array('db','otherlib');
</code></pre></div>
<p>Unless I&#39;ve forgotten something, that should be it...
Now in any of your controllers or files where autoloaded libraries are available, you can use
$this-&gt;db-cf()-&gt;phpCassaMethod();  to access Cassandra.
Feel free to ask any questions...comment suggestions are all welcome.</p>

    </article>
    <footer class="post-footer">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'zcourts'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
    </footer>
</div>

        </div>
        <!-- Footer -->
<div id="footer">
    <div class="share-footer">
        <span class='st_reddit_large' displayText='Reddit'></span>
        <span class='st_facebook_large' displayText='Facebook'></span>
        <span class='st_twitter_large' displayText='Tweet'></span>
        <span class='st_linkedin_large' displayText='LinkedIn'></span>
        <span class='st_pinterest_large' displayText='Pinterest'></span>
        <span class='st_tumblr_large' displayText='Tumblr'></span>
        <span class='st_wordpress_large' displayText='WordPress'></span>
        <span class='st_googleplus_large' displayText='Google +'></span>
        <span class='st_yammer_large' displayText='Yammer'></span>
        <span class='st_blogger_large' displayText='Blogger'></span>
        <span class='st_email_large' displayText='Email'></span>
    </div>
    <!-- Copyright -->
    <ul class="copyright">
        <li><a href="http://zcourts.com">&copy; zcourts</a></li>
        <li>i.e. &copy; Courtney Robinson. All rights reserved.</li>
    </ul>

</div>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-46289473-4', 'auto');
            ga('require', 'linkid', 'linkid.js');
            ga('send', 'pageview');
        </script>
        <script type="text/javascript">var switchTo5x=true;</script>
        <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
        <script type="text/javascript">stLight.options({publisher: "dd681bd6-1a3c-43f3-b378-df71c4cef728", doNotHash: false, doNotCopy: false, hashAddressBar: true});</script>
    </body>
</html>
