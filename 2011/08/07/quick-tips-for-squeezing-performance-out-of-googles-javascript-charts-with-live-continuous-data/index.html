<!DOCTYPE html>
<html>
        <head>
    <title>Quick tips for squeezing performance out of Google's Javascript charts with live (continuous) data/streams</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="description" content="I, until a few days ago always used JQuery for literally everything that needed Javascript. I&#39;ve recently needed to use Google charts to show a live grap...">
    <meta name="keywords" content="" />
    <script src="/js/jquery.min.js"></script>
    <script src="/js/init.js"></script>

    <link rel="stylesheet" href="/css/main.css">

    <link rel="canonical" href="//2011/08/07/quick-tips-for-squeezing-performance-out-of-googles-javascript-charts-with-live-continuous-data">
    <link rel="alternate" type="application/atom+xml" title="zcourts AKA Courtney Robinson" href="/feed.xml" />
</head>
    <body>
        <!-- Header -->
<div id="header" class="skel-layers-fixed">

    <div class="top">

        <!-- Logo -->
        <div id="logo">
            <span class="image avatar48"><img src="/images/avatar.jpg" alt=""/></span>

            <h1 id="title">zcourts</h1>
            <p>Courtney Robinson</p>
            <p>Software Engineer</p>
            <p>PhD Student</p>
        </div>

        <!-- Nav -->
        <nav id="nav">
            <!--

                Prologue's nav expects links in one of two formats:

                1. Hash link (scrolls to a different section within the page)

                   <li><a href="#foobar" id="foobar-link" class="icon fa-whatever-icon-you-want skel-layers-ignoreHref"><span class="label">Foobar</span></a></li>

                2. Standard link (sends the user to another page/site)

                   <li><a href="http://foobar.tld" id="foobar-link" class="icon fa-whatever-icon-you-want"><span class="label">Foobar</span></a></li>

            -->
            <ul>
                <li><a href="/#top" id="top-link" class="skel-layers-ignoreHref"><span class="icon fa-home">Home</span></a></li>
                <li><a href="/#portfolio" id="portfolio-link" class="skel-layers-ignoreHref"><span class="icon fa-th">Projects</span></a></li>
                <li><a href="/posts" id="blog-link" class="skel-layers-ignoreHref"><span class=" glyphicon glyphicon-comment">Blog posts</span></a></li>
                <li><a href="/categories.html" id="cat-link" class="skel-layers-ignoreHref"><span class=" glyphicon glyphicon-tags">Categories</span></a></li>
                <li><a href="/about-courtney-robinson" id="about-link" class="skel-layers-ignoreHref"><span class="icon fa-user">About Me</span></a></li>
                <li><a href="/#contact" id="contact-link" class="skel-layers-ignoreHref"><span class="icon fa-envelope">Contact</span></a></li>
            </ul>
        </nav>

    </div>

    <div class="bottom">

        <!-- Social Icons -->
        <ul class="icons">
            <li><a href="https://twitter.com/zcourts" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
            <li><a href="https://www.facebook.com/zcourts" class="icon fa-facebook"><span class="label">Facebook</span></a></li>
            <li><a href="https://github.com/zcourts" class="icon fa-github"><span class="label">Github</span></a></li>
            <li><a href="mailto:site@crlog.info" class="icon fa-envelope"><span class="label">Email</span></a></li>
        </ul>

    </div>

</div>
        <!-- Main -->
        <div id="main">
            <div class="post">

    <header class="post-header">
        <h1 class="post-title">Quick tips for squeezing performance out of Google's Javascript charts with live (continuous) data/streams</h1>

        <p class="post-meta">Aug 7, 2011 • zcourts
            </p>
    </header>

    <article class="post-content">
        <p>I, until a few days ago always used JQuery for literally everything that needed Javascript. I&#39;ve recently needed to use <a href="http://code.google.com/apis/chart/">Google charts</a> to show a live graphical representation of data. It needed to be a widget that didn&#39;t rely on any framework so I had to brush up on my Javascript and forget all the easy stuff JQuery usually gives me! The chart would be updated EVERY SECOND, yeah pretty often! In every second there could be any amount of new points to be plotted. In addition, I&#39;m only interested in points that have occurred within a fixed time period, the results of all this will be an &quot;animated&quot; graph that shifts left when data is updated.&lt;!-- more --&gt;</p>

<p>On my first implementation (took about 3 hrs), it all worked &quot;great&quot;, or so I thought. After watching the graph work nicely for about 1hr ( I didn&#39;t sit and watch if you&#39;re wondering, I used console.log()!) chrome,firefox and IE just went poooof! IE (expectedly died a lot earlier than the others). To get an idea of what went wrong I restarted everything (killed Firefox and IE, leaving chrome with a single tab), watching my CPU and Memory usage...they did nothing but climb until the chrome process hit about 1GB, I got er, &quot;Ooops, He&#39;s dead Jim&quot; page...</p>

<p>It was obvious I had a nasty memory leak somewhere...I started going through the code, line by line. I did it over and over and only spotted one or two things that I thought could be the cause....Sadly, I was wrong so I started Googling around.</p>

<p>Like I said, I&#39;m (or was) no Javascript programmer...I didn&#39;t even know about garbage collection in Javascript. I found a few interesting resources though:</p>

<p>One interesting thing I found was about closure...Understanding this (or something about it can work wonders!). Here are a list of interesting things I found that helped me nail the problem down.</p>

<ol>
<li><p><a href="http://jibbering.com/faq/notes/closures/">Javascript closure (A must read)</a>, If this breaks use the <a href="http://webcache.googleusercontent.com/search?q=cache:I58BNV-HedYJ:jibbering.com/faq/notes/closures/+javascript+closure&amp;hl=en&amp;gl=uk&amp;strip=1">Google cached version</a>,it was broken when I tried to access it.</p></li>
<li><p><a href="http://www.javascriptkit.com/javatutors/closuresleak/index2.shtml">Javascript closure (A more concise introduction)</a></p></li>
<li><p><a href="http://www.crockford.com/javascript/private.html">Private Members</a> in Javascript</p></li>
<li><p><a href="http://www.javascriptkit.com/javatutors/closuresleak/index.shtml">JavaScript and Memory leaks</a></p></li>
<li><p><a href="http://www.ibm.com/developerworks/web/library/wa-memleak/">Javascript cyclic references</a></p></li>
<li><p><a href="http://stackoverflow.com/questions/2986039/ipad-iphone-browser-crashing-when-loading-images-in-javascript">Useful tips</a></p></li>
</ol>

<p>As I found out, Javascript garbage collection is done diferently in different browsers... I highly recommend reading the info on the links above!</p>

<p>So what did I do to &quot;fix&quot; my memory leaks?
After reading the stuff above, I went over the code again,</p>

<ul>
<li><p>I set properties to null after they were used, i.e. myObject.property=null</p></li>
<li><p>Used the delete  keyword on the properties that were set to null, i.e delete myObject.property ( Notice I said property. According to the <a href="https://developer.mozilla.org/en/JavaScript/Reference/Operators/Special/delete">mozilla docs</a>, the delete keyword doesn&#39;t work on variables that are either function references or declared using the var keyword.)-  From what I understand if myObject.property is not null then it may not be garbage collected depending on how it has been used so setting to null is your best bet if you want it gone.</p></li>
<li><p>I found and removed circular references (see bullet 5 above)</p></li>
<li><p>I used this.myproperty to store my live data object and other properties that were used multiple places</p></li>
<li><p>I set this.myproperty to null when necessary</p></li>
<li><p>Re-used this.myproperty instead of creating a new object</p></li>
</ul>

<p>Google charts, what an amazing monster! When I first looked at its APIs, I thought &quot;ehhhhhh&quot;, I didn&#39;t know this was possible with Javascript! It was easy to get going and my charts were looking good.  I adjusted a few settings in my program and watched the chrome process to work out that:</p>
<div class="highlight"><pre><code class="language-" data-lang=""> *In 4 minutes 40MB of additional memory was used with timeout
 *of 10 seconds (i.e. update charts every 10 seconds instead of every second)
 *That's 10mb per minute and refreshed 6 times (60 seconds/10 seconds timeout) in a minute
 *so 10/6=1.6MB... memory per iteration/refresh...
</code></pre></div>
<p>So in my first version of the program ~1.6MB of memory was being added each time the chart was refreshed/redrawn. That is just terrible! Even more terrifying was the fact that it just grew and grew and never levelled off!</p>

<p>I commented out the chart drawing code and left all the other processing code to run. After monitoring the chrome process for a few minutes, about 10, the memory usage moved from about 40MB to 42MB, when I did the same thing, prior to reading up and optimizing the memory added over about 5 minutes was in excess of 100MB and kept growing, clearly my optimization was effective.</p>

<p>I left the chart drawing commented and left the process running for about an hour, give or take. The maximum memory I saw was 60MB and this went back down to the 40&#39;s in seconds!</p>

<p>I was happy with this now so I uncommented the graph code and it started going up again, admittedly by a lot less than before, and I suppose some increase was to be expected considering the stuff had to be drawn... After seeing the memory level off without the graph I was convinced the whole thing working together could level off at an acceptable memory level. I dug through the Google charts reference and found that, I don&#39;t need to recreate my datatable object each time.</p>

<ul>
<li><p>Instead of recreating the <a href="http://code.google.com/apis/chart/interactive/docs/reference.html#DataTable">DataTable</a>, I used the remove rows method of the object to remove the first row to N, where N is the row number up to which I want to remove. So if I want to get rid of row numbers 0 to 5, I would use, mytable.removeRows(0,5)</p></li>
<li><p>The second thing I did was stopped the re-creation of a graph on each update (You have no idea how expensive this was!), I made the graph object a property accessible under this.mygraph - this would only ever be created once if it is null</p></li>
<li><p>Finally, I updated/refactored the code so that this.mygrapgh.chart is the only thing being invoked on each update.</p></li>
</ul>

<p>The graph now works with real time data and updates every second, memory usage averages about 100MB, I&#39;ve seen 120MB  but it sometimes drop as low as 80MB and hasn&#39;t grown any more. I would certainly like to think I&#39;ve fixed the memory leaks, if I haven&#39;t I&#39;ve done pretty well at whatever&#39;s made it stay consistently low for hours on end. The graph has so far processed over 78hrs of data and the 120MB is the highest I&#39;ve seen.</p>

<p>I may have been a total novice (possibly still is) but I&#39;ve definitely learnt a metric tonne from this (I even implemented a fairly advanced <a href="https://github.com/zcourts/javascript-hashSet">key value set</a> to keep my data sorted and accessible by keys), I hope this hasn&#39;t all been a long rant and is useful to you or helps you pinpoint where your javascript program is blowing up.</p>

    </article>
    <footer class="post-footer">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'zcourts'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
    </footer>
</div>

        </div>
        <!-- Footer -->
<div id="footer">
    <!-- Copyright -->
    <ul class="copyright">
        <li><a href="http://zcourts.com">&copy; zcourts</a></li>
        <li>i.e. &copy; Courtney Robinson. All rights reserved.</li>
    </ul>

</div>
        <div class="addthis_toolbox addthis_default_style " id="addthisURL" addthis:url=""></div>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-46289473-4', 'auto');
            ga('require', 'linkid', 'linkid.js');
            ga('send', 'pageview');
            document.getElementById("addthisURL").setAttribute("addthis:url",window.location.href);
        </script>
        <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=zcourts" async="async"></script>
    </body>
</html>
