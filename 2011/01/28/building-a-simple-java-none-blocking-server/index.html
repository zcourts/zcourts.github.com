<!DOCTYPE html>
<html>
        <head>
    <title>Building a simple Java none-blocking server</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="description" content="O&#39;reily NIO tutorial(1)">
    <meta name="keywords" content="" />
    <script src="/js/jquery.min.js"></script>
    <script src="/js/init.js"></script>

    <link rel="stylesheet" href="/css/main.css">

    <link rel="canonical" href="//2011/01/28/building-a-simple-java-none-blocking-server">
    <link rel="alternate" type="application/atom+xml" title="zcourts AKA Courtney Robinson" href="/feed.xml" />
</head>
    <body>
        <!-- Header -->
<div id="header" class="skel-layers-fixed">

    <div class="top">

        <!-- Logo -->
        <div id="logo">
            <span class="image avatar48"><img src="/images/avatar.jpg" alt=""/></span>

            <h1 id="title">zcourts</h1>
            <p>Courtney Robinson</p>
            <p>Software Engineer</p>
            <p>PhD Student</p>
        </div>

        <!-- Nav -->
        <nav id="nav">
            <!--

                Prologue's nav expects links in one of two formats:

                1. Hash link (scrolls to a different section within the page)

                   <li><a href="#foobar" id="foobar-link" class="icon fa-whatever-icon-you-want skel-layers-ignoreHref"><span class="label">Foobar</span></a></li>

                2. Standard link (sends the user to another page/site)

                   <li><a href="http://foobar.tld" id="foobar-link" class="icon fa-whatever-icon-you-want"><span class="label">Foobar</span></a></li>

            -->
            <ul>
                <li><a href="/#top" id="top-link" class="skel-layers-ignoreHref"><span class="icon fa-home">Home</span></a></li>
                <li><a href="/#portfolio" id="portfolio-link" class="skel-layers-ignoreHref"><span class="icon fa-th">Projects</span></a></li>
                <li><a href="/posts" id="blog-link" class="skel-layers-ignoreHref"><span class=" glyphicon glyphicon-comment">Blog posts</span></a></li>
                <li><a href="/categories.html" id="cat-link" class="skel-layers-ignoreHref"><span class=" glyphicon glyphicon-tags">Categories</span></a></li>
                <li><a href="/about-courtney-robinson" id="about-link" class="skel-layers-ignoreHref"><span class="icon fa-user">About Me</span></a></li>
                <li><a href="/#contact" id="contact-link" class="skel-layers-ignoreHref"><span class="icon fa-envelope">Contact</span></a></li>
            </ul>
        </nav>

    </div>

    <div class="bottom">

        <!-- Social Icons -->
        <ul class="icons">
            <li><a href="https://twitter.com/zcourts" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
            <li><a href="https://www.facebook.com/zcourts" class="icon fa-facebook"><span class="label">Facebook</span></a></li>
            <li><a href="https://github.com/zcourts" class="icon fa-github"><span class="label">Github</span></a></li>
            <li><a href="mailto:site@crlog.info" class="icon fa-envelope"><span class="label">Email</span></a></li>
        </ul>

    </div>

</div>
        <!-- Main -->
        <div id="main">
            <div class="post">

    <header class="post-header">
        <h1 class="post-title">Building a simple Java none-blocking server</h1>

        <p class="post-meta">Jan 28, 2011 â€¢ zcourts
            </p>
    </header>

    <article class="post-content">
        <p><a href="http://tim.oreilly.com/pub/a/onjava/2002/09/04/nio.html?page=1">O&#39;reily NIO tutorial</a>(1)</p>

<p>I found myself in need of a way to connect to <a href="http://cassandra.apache.org">Cassandra 0.7</a>
Existing clients are either unreliable or none existent. Being a fan of the
Java <a href="https://github.com/rantav/hector">hector client</a> (which is undoubtedly the best I&#39;ve found) I decided to write a language independent
&quot;wrapper&quot; around the hector API.</p>

<p>I&#39;ll cover the client a different blog post, but I wanted to write a socket server that&#39;ll handle multiple users at the same time.
I t turns out using the raw <a href="http://java.sun.com/developer/technicalArticles/javase/nio/">Java NIO</a> package would end taking the attention away from writing the Cassandra &quot;client&quot; so in the end
I used the server library, <a href="http://www.jboss.org/netty/">Netty</a>... Below is the code I had up to the point I moved to Netty.
It allows multiple connections on the same socket but the requests are still processed sequentially which means, if a single request
hangs then all subsequent requests will hang until the connections start to timeout or the server is overloaded and turns over.</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">info</span><span class="o">.</span><span class="na">crlog</span><span class="o">.</span><span class="na">server</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">info.crlog.interfaces.Constants</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.CharBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SelectionKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.Selector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.ServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.Charset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.CharsetDecoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.logging.Level</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.logging.Logger</span><span class="o">;</span>

<span class="cm">/**
 *based on http://tim.oreilly.com/pub/a/onjava/2002/09/04/nio.html?page=2
 * @author Courtney
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="kd">implements</span> <span class="n">Constants</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">9969</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">"127.0.0.1"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="n">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Server</span> <span class="n">serv</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Server</span><span class="o">();</span>
        <span class="n">serv</span><span class="o">.</span><span class="na">init</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="n">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Create the server socket channel</span>
            <span class="n">ServerSocketChannel</span> <span class="n">server</span> <span class="o">=</span> <span class="n">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
            <span class="c1">// nonblocking I/O</span>
            <span class="n">server</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="c1">// host-port</span>
            <span class="n">server</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">));</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Server connected on "</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">port</span><span class="o">);</span>
            <span class="c1">// Create the selector</span>
            <span class="n">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="n">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
            <span class="c1">// Recording server to selector (type OP_ACCEPT)</span>
            <span class="n">server</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>
            <span class="c1">// Infinite server loop</span>
            <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
                <span class="c1">// Waiting for events</span>
                <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
                <span class="c1">// Get keys</span>
                <span class="n">Set</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span>
                <span class="n">Iterator</span> <span class="n">i</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
                <span class="c1">// For each keys...</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="o">(</span><span class="n">SelectionKey</span><span class="o">)</span> <span class="n">i</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                    <span class="c1">// Remove the current key</span>
                    <span class="n">i</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                    <span class="c1">//see if client is requesting connection</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">acceptConn</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">server</span><span class="o">,</span> <span class="n">selector</span><span class="o">))</span> <span class="o">{</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>

                    <span class="c1">// then the server is ready to read</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">performIO</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">Server</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()).</span><span class="na">log</span><span class="o">(</span><span class="n">Level</span><span class="o">.</span><span class="na">SEVERE</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">performIO</span><span class="o">(</span><span class="n">SelectionKey</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">SocketChannel</span> <span class="n">client</span> <span class="o">=</span> <span class="o">(</span><span class="n">SocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
            <span class="c1">// Read byte coming from the client</span>
            <span class="kt">int</span> <span class="n">BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">32</span><span class="o">;</span>
            <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">BUFFER_SIZE</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">client</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// client is no longer active</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
            <span class="n">Charset</span> <span class="n">charset</span> <span class="o">=</span> <span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"ISO-8859-1"</span><span class="o">);</span>
            <span class="n">CharsetDecoder</span> <span class="n">decoder</span> <span class="o">=</span> <span class="n">charset</span><span class="o">.</span><span class="na">newDecoder</span><span class="o">();</span>
            <span class="n">CharBuffer</span> <span class="n">charBuffer</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
            <span class="n">Handler</span> <span class="n">dataHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">();</span>
            <span class="n">client</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">dataHandler</span><span class="o">.</span><span class="na">processInput</span><span class="o">(</span><span class="n">charBuffer</span><span class="o">.</span><span class="na">toString</span><span class="o">()).</span><span class="na">getBytes</span><span class="o">()));</span>
            <span class="n">client</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">acceptConn</span><span class="o">(</span><span class="n">SelectionKey</span> <span class="n">key</span><span class="o">,</span> <span class="n">ServerSocketChannel</span> <span class="n">server</span><span class="o">,</span> <span class="n">Selector</span> <span class="n">selector</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="c1">// if isAccetable = true</span>
        <span class="c1">// then a client required a connection</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// get client socket channel</span>
            <span class="n">SocketChannel</span> <span class="n">client</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
            <span class="c1">// Non Blocking I/O</span>
            <span class="n">client</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="c1">// recording to the selector (reading)</span>
            <span class="n">client</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>There are comments included to help you follow, the page cited below has an excellent tutorial and indept description of how
to get this all done so if you&#39;re having problems making it work, ask in the comments or have a read through the tutorial linked
below.
Further reading:
[1]<a href="http://tim.oreilly.com/pub/a/onjava/2002/09/04/nio.html">Introducing Nonblocking Sockets</a> by <a href="http://tim.oreilly.com/pub/au/1021">Giuseppe Naccarato</a></p>

    </article>
    <footer class="post-footer">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'zcourts'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
    </footer>
</div>

        </div>
        <!-- Footer -->
<div id="footer">
    <!-- Copyright -->
    <ul class="copyright">
        <li><a href="http://zcourts.com">&copy; zcourts</a></li>
        <li>i.e. &copy; Courtney Robinson. All rights reserved.</li>
    </ul>

</div>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-46289473-4', 'auto');
            ga('require', 'linkid', 'linkid.js');
            ga('send', 'pageview');

        </script>
    </body>
</html>
